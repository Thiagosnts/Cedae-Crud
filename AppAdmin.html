<html>

<head>
    <meta http-equiv="Content-Type" content="text/html; charset=utf-8">
    <link href="Style/estilo.css" rel="stylesheet">

    <script src="Mapa/municipiosBaseGeo.js"></script>
    <script src="Mapa/coordenadasJson.js"></script>
    <script src="https://ajax.googleapis.com/ajax/libs/jquery/3.5.1/jquery.min.js"></script>
</head>


<body class="body-region">
    <h2 class="topo align-center">Cadastro de Regiões</h2>
    <div class="row-region">

        <div class="col-region">
            <fieldset>
                <legend class="legenda bordaVerde">Municipios Ativos</legend>

                <div id="locais"></div>
            </fieldset>
        </div>

        <div class="col-region">
            <fieldset>
                <legend class="legenda bordaVerde">Concessionaria</legend>
                <select onchange="" class="listaConc" id="" name="">
                    <option value="0"> -- TODAS -- </option>
                </select>
                <br>
                <br>

                <legend class="legenda">Cidade</legend>
                <input onkeyup="preencherLocalizacao()" id="cidade" type="text">
                <br>
                <br>
                <legend class="legenda">Bairro</legend>
                <input id="bairro" type="text">
                <br>
                <br>
                <legend class="legenda">Coordenadas</legend>
                <input id="coordenadas" type="text">
                <br>
                <label style="font-size: 10px;"><b style="margin-right: 2px;">Ex:</b>-22.059537,-42.8959</label>
                <br>
                <br>
                <button onclick="salvarItem()">Adicionar</button>

                <table class="table-region"  id="tabela">
                    <tr>
                        <th class="tabel-label">Concessionaria</th>
                        <th class="tabel-label">Cidade</th>
                        <th class="tabel-label">Bairro</th>
                        <th class="tabel-label"></th>
                    </tr>

                </Table>

            </fieldset>
        </div>

        <div class="col-region">
            <fieldset>
                <legend class="legenda bordaVerde">Concessionaria</legend>
                <input id="empresa" type="text">

                <br>
                <br>
                <button onclick="salvarEmpresa()">Adicionar</button>



                <table class="table-region"  id="Concessionarias">
                    <tr>
                        <th class="tabel-label">Concessionarias</th>
                        <th class="tabel-label"></th>
                    </tr>

                </Table>
            </fieldset>
        </div>


    </div>
    <br>
    <br>
</body>

</html>

<script>
    var dadosJsonGlobal;

    getDados()



    function getMap() {
        var comboBox = document.getElementById("locais")

        for (var i = 0; i < municipiosBase.features.length; i++) {
            var input = document.createElement("input")
            input.type = "checkbox";
            input.id = i

            if (dadosJsonGlobal.MunAtivos.indexOf(String(i)) != -1)
                input.checked = true

            input.value = i
            input.name = municipiosBase.features[i].properties.name

            input.setAttribute("onchange", 'salvarMunicipio(this)')

            var label = document.createElement("label")
            label.innerHTML = municipiosBase.features[i].properties.name + "<br><hr>"
            label.for = "vehicle1"

            comboBox.appendChild(input)
            comboBox.appendChild(label)
        }
    }


    function getDados() {
        $.ajax({
            url: 'AppListaBack.aspx',
            cache: false,
            type: "POST",
            data: "o",
            success: function (response) {
                MontarListaItem(JSON.parse(response))
                carregarLista(JSON.parse(response))
                MontarListaEmpresa(JSON.parse(response))
                dadosJsonGlobal = JSON.parse(response)
                getMap()
            },
            error: function () {
                //mockado
                MontarListaItem(solicitarDadosMock())
                carregarLista(solicitarDadosMock())
                dadosJsonGlobal = solicitarDadosMock()
                getMap()

                //alert('deu ruim')
            }
        })
    }


    function salvarDados() {

        $.ajax({
            url: 'AppBack.aspx',
            cache: false,
            type: "POST",
            data: "dados=" + JSON.stringify(dadosJsonGlobal),
            success: function (response) {
                console.log("Salvo com sucesso !!!")
            },
            error: function () {
                alert('deu ruim')
            }
        })
    }


    function solicitarDadosMock() {
        var dadosString = '{ "Concessionarias": [ "Sanepar", "Rio Aguas" ],"MunAtivos": [1,3,5],"item": [ { "Concessionaria": "Sanepar", "Cidade": "Rio de janeiro", "Bairro": "Campo Grande" },{ "Concessionaria": "Rio Aguas", "Cidade": "Sao Paulo", "Bairro": "Capao Redondo" } ] }'
        return JSON.parse(dadosString);
    }


    function MontarListaItem(dados) {
        var itens = dados.item
        var tabela = document.getElementById('tabela')

        for (var i = 0; i < itens.length; i++) {

            var linha = gerarLinhaItem(itens[i], i)
            tabela.appendChild(linha)

        }
    }


    function MontarListaEmpresa(dados) {
        var itens = dados.Concessionarias
        var tabela = document.getElementById('Concessionarias')

        for (var i = 0; i < itens.length; i++) {
            var linha = document.createElement('tr')

            var coluna = document.createElement('td')
            coluna.innerHTML = itens[i]
            linha.appendChild(coluna)
            tabela.appendChild(linha)

            var botao = document.createElement('button')
            botao.innerHTML = "Apagar"
            botao.setAttribute("onclick", "deletarEmpresa(this.value)")
            botao.value = i

            coluna = document.createElement('td')
            coluna.appendChild(botao)
            linha.appendChild(coluna)
            tabela.appendChild(linha)

        }
    }


    function gerarLinhaItem(item, indice) {
        var campos = [item.Concessionaria, item.Cidade, item.Bairro]
        var linha = document.createElement('tr')

        for (var i = 0; i < campos.length; i++) {
            var coluna = document.createElement('td')
            coluna.innerHTML = campos[i]
            linha.appendChild(coluna)
        }
        var coluna = document.createElement('td')

        var botao = document.createElement('button')
        botao.innerHTML = "Apagar"
        botao.setAttribute("onclick", "deletarItem(this.value)")
        botao.value = indice

        coluna.appendChild(botao)
        linha.appendChild(coluna)
        return linha
    }

    function carregarLista(dadosJson) {
        var listaConc = document.getElementsByClassName('listaConc')[0]
        for (var i = 0; i < dadosJson.Concessionarias.length; i++) {
            var itemLista = document.createElement("option")
            itemLista.value = dadosJson.Concessionarias[i]
            itemLista.innerHTML = dadosJson.Concessionarias[i].toUpperCase()
            listaConc.appendChild(itemLista)
        }
    }

    function salvarItem() {
        var Concessionaria = document.getElementsByClassName('listaConc')[0].value
        var cidade = document.getElementById("cidade").value
        var bairro = document.getElementById("bairro").value

        var coordenadas = document.getElementById("coordenadas").value.split(",")


        if (cidade && bairro && Concessionaria != 0) {
            var item = { "Concessionaria": Concessionaria, "Cidade": cidade, "Bairro": bairro, "Coordenadas": coordenadas }
            dadosJsonGlobal.item.push(item)
            console.log("salvando item")
            salvarDados()
            document.location.reload(true);
        }
        else {
            alert("Campo vazio ou Invalido !!!")
            return 0
        }

        if (coordenadas.length != 2) {
            alert("Coordenadas Invalidas !!!")
            return 0
        }
    }

    function deletarItem(indice) {

        dadosJsonGlobal.item.splice(indice, 1)
        console.log("deletando item " + indice)
        salvarDados()
        document.location.reload(true);

    }

    function salvarEmpresa() {
        var empresa = document.getElementById("empresa").value

        if (empresa) {
            dadosJsonGlobal.Concessionarias.push(empresa)
            console.log("salvando empresa")
            salvarDados()
            document.location.reload(true);
        }
    }

    function salvarMunicipio(municipio) {
        var indice = municipio.value
        var indiceDelete = dadosJsonGlobal.MunAtivos.indexOf(indice)

        if (municipio.checked) {
            dadosJsonGlobal.MunAtivos.push(municipio.value)
            salvarDados()
        }
        else {
            dadosJsonGlobal.MunAtivos.splice(indiceDelete, 1)
            salvarDados()
        }
    }

    function deletarEmpresa(indice) {
        dadosJsonGlobal.Concessionarias.splice(indice, 1)
        console.log("deletando item " + indice)
        salvarDados()
        document.location.reload(true);
    }


    function preencherLocalizacao() {
        var cidade = document.getElementById("cidade").value

        var localizacao = getLocalizacao(cidade)
        if (localizacao)
            document.getElementById("coordenadas").value = localizacao
        else
            document.getElementById("coordenadas").value = null

    }

    //Busca geolocalização de um Municipio especifico
    function getLocalizacao(cidade) {

        var localizacao = CoordenadasGeo.find(item => checkString(item.nome) === checkString(cidade));

        if (localizacao) {
            var latitude = localizacao.latitude
            var longitude = localizacao.longitude
            return latitude + ',' + longitude
        }
        return false
    }

    //Normaliza uma String(removendo acentos e caracteres especiais)
    function checkString(texto) {
        texto = texto.toLowerCase()
        texto = texto.normalize('NFD').replace(/[\u0300-\u036f]/g, '');
        return texto
    }



</script>