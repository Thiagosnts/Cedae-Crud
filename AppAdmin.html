<style>
    th {
        background-color: darkmagenta !important;
        color: white;
        font-size: 20;
    }

    td,
    th {
        padding: 10px 20px 10px 20px;
        border: solid 1px black;
        background-color: white;
    }

    table {
        margin: 50px auto auto auto;
        border-collapse: collapse;
        border-radius: 20px;
        box-shadow: 4px 4px 9px rgb(0 0 0 / 44%);

    }

    h2 {
        text-align: center;
    }

    html {
        background-color: cadetblue;
        border-top: solid 50px black;

    }

    .salvar {
        margin: auto;
        display: block;
        text-align: center;
    }

    .row {
        display: grid;
        grid-template-columns: auto auto;
    }
</style>

<script src="https://ajax.googleapis.com/ajax/libs/jquery/3.5.1/jquery.min.js"></script>

<h2>Admin</h2>
<div class="row">
    <div class="salvar">
        <legend>Concessionaria</legend>
        <select onchange="" class="listaConc" id="" name="">
            <option value="0"> -- TODAS -- </option>
        </select>
        <legend>Cidade</legend>
        <input id="cidade" type="text">
        <legend>Bairro</legend>
        <input id="bairro" type="text">
        <br>
        <button onclick="salvarItem()">Adicionar</button>

        <Table id="tabela">
            <tr>
                <th>Concessionaria</th>
                <th>Cidade</th>
                <th>Bairro</th>
                <th></th>

                <!--<th><button>Apagar</button></th>-->
            </tr>

        </Table>


    </div>

    <div class="salvar">
        <legend>Concessionaria</legend>
        <input id="empresa" type="text">

        <br>
        <br>
        <button>Adicionar</button>
        <br>
        <br>

        <Table id="Concessionarias">
            <tr>
                <th>Concessionarias</th>
                <th></th>
            </tr>
            <!-- <tr>
                <td>Rio Aguas</td>
                <td><button>Apagar</button></td>
            </tr> -->
        </Table>
    </div>

</div>
<br>
<br>


<script>
    var dadosJsonGlobal;


    getDados()


    function getDados() {
        $.ajax({
            url: 'AppListaBack.aspx',
            cache: false,
            type: "POST",
            data: "o",
            success: function (response) {
                MontarListaItem(JSON.parse(response))
                carregarLista(JSON.parse(response))
                MontarListaEmpresa(JSON.parse(response))
                dadosJsonGlobal = JSON.parse(response)

            },
            error: function () {
                //mockado
                MontarListaItem(solicitarDadosMock())
                carregarLista(solicitarDadosMock())
                dadosJsonGlobal = solicitarDadosMock()

                //alert('deu ruim')
            }
        })
    }


    function salvarDados() {

        $.ajax({
            url: 'AppBack.aspx',
            cache: false,
            type: "POST",
            data: "dados="+JSON.stringify(dadosJsonGlobal),
            success: function (response) {
                document.location.reload(true);
            },
            error: function () {
                alert('deu ruim')
            }
        })
    }


    function solicitarDadosMock() {
        var dadosString = '{ "Concessionarias": [ "Sanepar", "Rio Aguas" ],"item": [ { "Concessionaria": "Sanepar", "Cidade": "Rio de janeiro", "Bairro": "Campo Grande" },{ "Concessionaria": "Rio Aguas", "Cidade": "Sao Paulo", "Bairro": "Capao Redondo" } ] }'
        return JSON.parse(dadosString);
    }


    function MontarListaItem(dados) {
        var itens = dados.item
        var tabela = document.getElementById('tabela')

        for (var i = 0; i < itens.length; i++) {

            var linha = gerarLinhaItem(itens[i], i)
            tabela.appendChild(linha)

        }
    }


    function MontarListaEmpresa(dados) {
        var itens = dados.Concessionarias
        var tabela = document.getElementById('Concessionarias')

        for (var i = 0; i < itens.length; i++) {
            var linha = document.createElement('tr')

            var coluna = document.createElement('td')
            coluna.innerHTML = itens[i]
            linha.appendChild(coluna)
            tabela.appendChild(linha)

            var botao = document.createElement('button')
            botao.innerHTML = "Apagar"
            botao.setAttribute("onclick", "deletarEmpresa(this.value)")
            botao.value = i
            
            coluna = document.createElement('td')
            coluna.appendChild(botao)
            linha.appendChild(coluna)
            tabela.appendChild(linha)

        }
    }


    function gerarLinhaItem(item, indice) {
        var campos = [item.Concessionaria, item.Cidade, item.Bairro]
        var linha = document.createElement('tr')

        for (var i = 0; i < campos.length; i++) {
            var coluna = document.createElement('td')
            coluna.innerHTML = campos[i]
            linha.appendChild(coluna)
        }
        var coluna = document.createElement('td')

        var botao = document.createElement('button')
        botao.innerHTML = "Apagar"
        botao.setAttribute("onclick", "deletarItem(this.value)")
        botao.value = indice

        coluna.appendChild(botao)
        linha.appendChild(coluna)
        return linha
    }

    function carregarLista(dadosJson) {
        var listaConc = document.getElementsByClassName('listaConc')[0]
        for (var i = 0; i < dadosJson.Concessionarias.length; i++) {
            var itemLista = document.createElement("option")
            itemLista.value = dadosJson.Concessionarias[i]
            itemLista.innerHTML = dadosJson.Concessionarias[i].toUpperCase()
            listaConc.appendChild(itemLista)
        }
    }

    function salvarItem() {
        var Concessionaria = document.getElementsByClassName('listaConc')[0].value
        var cidade = document.getElementById("cidade").value
        var bairro = document.getElementById("bairro").value


        if (cidade && bairro && Concessionaria!=0) {
            var item = { "Concessionaria": Concessionaria, "Cidade": cidade, "Bairro": bairro }
            dadosJsonGlobal.item.push(item)
            console.log("salvando item")
            salvarDados()
        }
    }

    function deletarItem(indice) {
        dadosJsonGlobal.item.pop(indice)
        console.log("deletando item " + indice)
        salvarDados()
    }

    function salvarEmpresa() {
        var Concessionaria = document.getElementsByClassName('listaConc')[0].value
        var cidade = document.getElementById("cidade").value
        var bairro = document.getElementById("bairro").value


        if (cidade && bairro && Concessionaria!=0) {
            var item = { "Concessionaria": Concessionaria, "Cidade": cidade, "Bairro": bairro }
            dadosJsonGlobal.item.push(item)
            console.log("salvando item")
            salvarDados()
        }
    }

    function deletarEmpresa(indice) {
        dadosJsonGlobal.Concessionarias.pop(indice)
        console.log("deletando item " + indice)
        salvarDados()
    }


</script>